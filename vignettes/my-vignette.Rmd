---
title: "Running the mdp package"
author: "Melissa Lever"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## About

The Molecular Degree of Perturbation allows you to quantify the heterogeneity of transcriptome data samples. The `mdp` takes data containing at least two classes (control and test) and assigns a score to all samples based on how perturbed they are compared to the controls. Gene perturbation scores are calculated for each gene within each class. 

## Basic usage

Load expression and pheno data:

```{r}
library(mdp)
data(example_data) # expression data has gene names in the rows
data(example_pheno) # pheno data needs a Sample and Class column

head(example_data[,1:5]) 
head(example_pheno) 
```

#### Run `mdp` and get sample scores

Run the `mdp` and plot sample scores 
```{r}
mdp.results <- mdp(data=example_data, pdata=example_pheno, control_lab = "baseline")
sample_scores <- mdp.results$sample_scores
# select sample scores that are calculated using all genes
sample_scores <- sample_scores[sample_scores$Geneset == "allgenes",] 
smdp_plot(sample_scores)
```

#### Z-score 
The `mdp` works by calulating the z-score relative to the control samples, taking the absolute value of this matrix and setting all vlaues below a threshold (2 as a default) to 0. Expression values that are not 0 are *perturbed*. You can access this thresholded z-score matrix by,
```{r}
zscore <- mdp.results$zscore
```


#### Gene scores
For each gene in each class, a gene score is calculated, which is the average thresholded z-score value for that gene. A gene frequency is also calculated, which is the frequency that the gene is perturbed in a class.
```{r}
gene_scores <- mdp.results$gene_scores
gene_freq <- mdp.results$gene_freq

```


#### Perturbed genes
The `mdp` ranks genes according to the difference between their gene score in the test versus the control samples. The `fraction_genes` option for the `mdp` function allows you to control what fraction of these ranked genes will count as the `perturbed_genes`. You can obtain a list of the perturbed genes,
```{r}
perturbed_genes <- mdp.results$perturbed_genes
```

## Further usage

#### Adding pathways
Sample scores can also be calculated using genes that are within certain genesets. These genesets will be in a list form (see example below).
If you have a .gmt file of genesets, this can be loaded using for example the `fgsea::gmtPathways` function from the `fgsea` package.


```{r}
data(pathways) # expression data has gene names in the rows
mdp.results <- mdp(data=example_data, pdata=example_pheno, control_lab = "baseline",pathways=pathways)

```

#### Z-score calculation options


Alternatively you can calculate the thresholded z-score using `compute_zscore`,
```{r}
control_samples <- example_pheno[example_pheno$Class == "baseline","Sample"]
zscore <- compute_zscore(data = example_data,control_samples = control_samples,measure = "mean",std = 2)
```









